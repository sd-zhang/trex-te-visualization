<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Hello World</title>
  <style>* {padding: 0; margin: 0}</style>
</head>
<body>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js" integrity="sha512-Y8iWYJDo6HiTo5xtml1g4QqHtl/PO1w+dmUpQfQSOTqKNsMhExfyPN2ncNAe9JuJUSKzwK/b6oaNPop4MXzkwg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/MotionPathPlugin.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.10.4/PixiPlugin.min.js"></script>
  <script type="text/javascript">
    let type = "WebGL";
    if (!PIXI.utils.isWebGLSupported()) {
      type = "canvas";
    }

    //Aliases
    const Application = PIXI.Application,
          Container = PIXI.Container,
          loader = PIXI.Loader.shared,
          resources = PIXI.Loader.shared.resources,
          TextureCache = PIXI.utils.TextureCache,
          Sprite = PIXI.Sprite,
          Rectangle = PIXI.Rectangle
          Graphics = PIXI.Graphics

    //Create a Pixi Application
    const app = new Application({
        width: 256,         // default: 800
        height: 256,        // default: 600
        antialias: true,    // default: false
        transparent: false, // default: false
        resolution: 1       // default: 1
    });

    app.renderer.backgroundColor = 0xffffff;
    app.renderer.autoDensity = true;
    app.resizeTo = window;
    //Add the canvas that Pixi automatically created for you to the HTML document
    document.body.appendChild(app.view);

    loader
    .add("generic_node", "images/generic_node.png")
    .add("feeder_node", "images/feeder_node.png")
    .add("home_node", "images/home_node.png")
    // .add("dabrex_sprite", "images/dabrex.png")
    .add("conveyor", "/images/conveyer_snipp.png" )
    .load(setup);

    function setup() {
      // load node map json into variable
      node_size = 32;
      edge_scale = node_size * 3

      $.getJSON("data/node_map.json", function(node_map){
        // console.log(node_map);
            // console.log(node_map.name); // Prints: Harry
            // console.log(node_map.age); // Prints: 14

        // draw node sprites based on node_map
      var nodes = {};
      for (let node in node_map) {
        // console.log(node)
        switch(node_map[node]["type"]) {
          case "feeder":
            nodes[node] = new Sprite(resources.feeder_node.texture);
            break;
          case "home":
            nodes[node] = new Sprite(resources.home_node.texture);
            break;
          default:
            nodes[node] = new Sprite(resources.generic_node.texture);
            break;
        }
        // console.log(*node_map[node]["pos"])
        nodes[node].width = node_size;
        nodes[node].height = node_size;
        var x_pos = edge_scale * node_map[node]["pos"][0]
        var y_pos = edge_scale * node_map[node]["pos"][1]

        nodes[node].position.set(x_pos, y_pos)
        app.stage.addChild(nodes[node]);
      }
        }).fail(function(){
            console.log("An error has occurred.");
        });

        var conveyor1 = new Sprite(resources.conveyor.texture);
        conveyor1.width = node_size;
        conveyor1.height = node_size;
        conveyor1.position.set(edge_scale*2, edge_scale*0  +node_size );
        app.stage.addChild(conveyor1);

        // 'line to display'
        let graphics = new PIXI.Graphics()
        graphics.lineStyle(3, 0x3500FA, 0.3);
        graphics.position.set((edge_scale * 2) + (node_size / 2 ), edge_scale * 0 + node_size);
        graphics.lineTo(0, edge_scale * 2)
        app.stage.addChild(graphics);

        // animation Path 
        var path = [{x:(edge_scale * 2)  , y : edge_scale * 2 }];  
        gsap.registerPlugin(MotionPathPlugin);
        
        // animation code  
        gsap.to(conveyor1, {
        duration: 0.5, 
        repeat: 500,
        repeatDelay: 0.3,
        yoyo: false,
        ease: "none",
        motionPath:{
          path: path,
          // align: path,
          autoRotate: false,
          alignOrigin: [0.5, 0.5]
        }
      });

        
    }

    // load powerflow csv into variable
    $.ajax({
      url: "data/powerflow_series.csv",
      async: false,
      success: function (csvd) {
          powerflow_i = $.csv.toObjects(csvd);
      },
      dataType: "text",
      complete: function () {
        console.log(powerflow_i)
          // call a function on complete 
      }
    });
    
    app.stage.addChild(graphics);
    

    // PIXI.utils.sayHello(type);
  </script>
</body>
</html>